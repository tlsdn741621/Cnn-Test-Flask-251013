<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì‚¼ì„± ì£¼ê°€ ì˜ˆì¸¡ (Flask + Vanilla JS)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 900px;
        margin: auto;
      }
      button {
        padding: 8px 12px;
        margin: 5px;
        cursor: pointer;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      button:disabled {
        cursor: not-allowed;
        background-color: #eee;
      }
      form {
        margin: 20px 0;
      }
      .data-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
      }
      h2,
      h3 {
        margin-top: 30px;
      }
    </style>
  </head>
  <body>
    <h3>ğŸ“ˆ ì‚¼ì„± ì£¼ê°€ ì˜ˆì¸¡</h3>
    <p>AIë¥¼ í™œìš©í•œ ì‚¼ì„± ì£¼ê°€ ì˜ˆì¸¡ ëª¨ë¸ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <form id="period-form">
      <label style="margin-right: 10px">
        <input type="radio" name="period" value="1d" /> 1ì¼
      </label>
      <label style="margin-right: 10px">
        <input type="radio" name="period" value="5d" /> 5ì¼ (4ì¼)
      </label>
      </form>

    <button id="fetch-data-btn">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>

    <div id="data-display"><p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>

    <div id="predict-buttons">
      <button data-model="RNN">RNN ì˜ˆì¸¡í•˜ê¸°</button>
      <button data-model="LSTM">LSTM ì˜ˆì¸¡í•˜ê¸°</button>
      <button data-model="GRU">GRU ì˜ˆì¸¡í•˜ê¸°</button>
    </div>

    <h2>ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼</h2>
    <div id="prediction-results">
      <h3>RNN: ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘</h3>
      <h3>LSTM: ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘</h3>
      <h3>GRU: ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘</h3>
    </div>

    <h2>ğŸ“‰ ì£¼ê°€ ë°ì´í„° ê·¸ë˜í”„</h2>
    <div>
      <canvas id="stock-chart" width="100%" height="400"></canvas>
    </div>

    <script>
      // 2. Reactì˜ state ì—­í• ì„ í•  ì „ì—­ ë³€ìˆ˜ë“¤
      let stockData = [];
      let predictions = {};
      let loading = false;
      let selectedPeriod = '';
      let chartInstance = null; // Chart.js ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜

      // 3. DOM ìš”ì†Œ ì°¸ì¡°
      const periodForm = document.getElementById('period-form');
      const fetchDataBtn = document.getElementById('fetch-data-btn');
      const dataDisplay = document.getElementById('data-display');
      const predictButtonsContainer = document.getElementById('predict-buttons');
      const predictionResults = document.getElementById('prediction-results');
      const chartCanvas = document.getElementById('stock-chart').getContext('2d');

      // 4. ë¡œë”© ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
      const setLoading = (isLoading) => {
        loading = isLoading;
        fetchDataBtn.disabled = loading;
        fetchDataBtn.textContent = loading ? 'ë¡œë”© ì¤‘...' : 'ë°ì´í„° ê°€ì ¸ì˜¤ê¸°';
        document
          .querySelectorAll('#predict-buttons button')
          .forEach((btn) => (btn.disabled = loading));
      };

      // 5. ì£¼ë§ ì œì™¸ ë‹¤ìŒ ì˜ì—…ì¼ ê³„ì‚° í•¨ìˆ˜ (React ì½”ë“œì™€ ë™ì¼)
      const getNextBusinessDay = (dateStr) => {
        let date = new Date(dateStr);
        do {
          date.setDate(date.getDate() + 1);
        } while (date.getDay() === 0 || date.getDay() === 6);
        return date.toISOString().split('T')[0];
      };

      // 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
      periodForm.addEventListener('change', (event) => {
        selectedPeriod = event.target.value;
      });

      fetchDataBtn.addEventListener('click', async () => {
        if (!selectedPeriod) {
          alert('ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.');
          return;
        }
        setLoading(true);
        try {
          // â—ï¸ Flask API ì—”ë“œí¬ì¸íŠ¸ ì˜ˆì‹œ: /api/stockdata?period=5d
          const response = await fetch(`/api/stockdata?period=${selectedPeriod}`);
          if (!response.ok) throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

          const data = await response.json();
          stockData = data; // ì „ì—­ ë³€ìˆ˜ì— ë°ì´í„° ì €ì¥
          predictions = {}; // ì˜ˆì¸¡ ê²°ê³¼ ì´ˆê¸°í™”
          renderStockData();
          renderPredictionResults();
          updateChart();
        } catch (error) {
          console.error(error);
          alert(error.message);
        }
        setLoading(false);
      });

      predictButtonsContainer.addEventListener('click', async (event) => {
        if (event.target.tagName !== 'BUTTON') return;
        const modelType = event.target.dataset.model;

        if (!selectedPeriod || stockData.length === 0) {
          alert('ê¸°ê°„ì„ ì„ íƒí•˜ê³  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ ì˜ˆì¸¡í•˜ì„¸ìš”.');
          return;
        }

        const periodDaysMap = { '1d': 1, '5d': 4 };
        const days = periodDaysMap[selectedPeriod] || 1;

        const inputData = stockData
          .slice(0, days)
          .map((item) => [
            parseFloat(item.Open) || 0,
            parseFloat(item.Low) || 0,
            parseFloat(item.High) || 0,
            parseFloat(item.Close) || 0,
          ]);

        setLoading(true);
        try {
          // â—ï¸ Flask API ì—”ë“œí¬ì¸íŠ¸ ì˜ˆì‹œ: /api/predict (POST)
          const response = await fetch('/api/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              model: modelType,
              data: inputData,
              period: selectedPeriod,
            }),
          });
          if (!response.ok) throw new Error('ì˜ˆì¸¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');

          const result = await response.json();
          predictions[modelType] = result.prediction; // ì˜ˆì¸¡ ê²°ê³¼ ì €ì¥
          renderPredictionResults();
          updateChart();
        } catch (error) {
          console.error(error);
          alert(error.message);
        }
        setLoading(false);
      });

      // 7. í™”ë©´ ë Œë”ë§ í•¨ìˆ˜ë“¤ (Reactì˜ ë Œë”ë§ ë¡œì§ ëŒ€ì²´)
      const renderStockData = () => {
        if (stockData.length === 0) {
          dataDisplay.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }
        dataDisplay.innerHTML = stockData
          .map(
            (item, index) => `
            <div class="data-item">
              <h4>${index + 1}ë²ˆì§¸ ë‚  (${item.Date})</h4>
              <p>ì‹œì‘ê°€: ${item.Open}</p>
              <p>ìµœì†Œê°€: ${item.Low}</p>
              <p>ìµœëŒ€ê°€: ${item.High}</p>
              <p>ì¢…ê°€: ${item.Close}</p>
            </div>
          `,
          )
          .join('');
      };

      const renderPredictionResults = () => {
        predictionResults.innerHTML = ['RNN', 'LSTM', 'GRU'].map(model =>
            `<h3>${model}: ${predictions[model] || 'ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘'}</h3>`
        ).join('');
      };

      // 8. Chart.jsë¥¼ ì‚¬ìš©í•œ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      const updateChart = () => {
        if (chartInstance) {
          chartInstance.destroy(); // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì œê±°
        }

        if (stockData.length === 0) return;

        const lastDate = stockData[stockData.length - 1].Date;
        const nextBusinessDay = getNextBusinessDay(lastDate);

        const labels = stockData.map(d => d.Date);
        if (Object.keys(predictions).length > 0) {
            labels.push(nextBusinessDay); // ì˜ˆì¸¡ì´ ìˆìœ¼ë©´ ë‹¤ìŒ ë‚ ì§œ ì¶”ê°€
        }

        const closeData = stockData.map(d => parseFloat(d.Close));

        // ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ì°¨íŠ¸ ë°ì´í„° í˜•ì‹ì— ë§ê²Œ ê°€ê³µ
        const createPredictionDataset = (model, color) => {
            const data = new Array(stockData.length).fill(null);
            if (predictions[model]) {
                data.push(parseFloat(predictions[model]));
            }
            return {
                label: `${model} ì˜ˆì¸¡`,
                data: data,
                borderColor: color,
                tension: 0.1,
                pointRadius: 5,
                pointBackgroundColor: color,
            };
        };

        chartInstance = new Chart(chartCanvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'ì‹¤ì œ ì¢…ê°€',
                data: closeData,
                borderColor: '#8884d8',
                tension: 0.1,
              },
              createPredictionDataset('RNN', '#ff0000'),
              createPredictionDataset('LSTM', '#00ff00'),
              createPredictionDataset('GRU', '#0000ff'),
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
          },
        });
      };

      // ì´ˆê¸° ë Œë”ë§
      updateChart();

    </script>
  </body>
</html>