<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Model Playground</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      /* ì£¼ì‹ ì˜ˆì¸¡ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
      .stock-body {
        font-family: sans-serif;
        padding: 20px;
        max-width: 900px;
        margin: auto;
      }
      .stock-body button:disabled {
        cursor: not-allowed;
        background-color: #eee;
      }
      .stock-body form {
        margin: 20px 0;
      }
      .data-item {
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
      }
      .stock-body h2,
      .stock-body h3 {
        margin-top: 30px;
      }
    </style>
</head>
<body>
    <h1>ğŸ¤– AI Model Playground</h1>
    <p>ì•„ë˜ì—ì„œ ì›í•˜ëŠ” AI ê¸°ëŠ¥ì„ ì„ íƒí•˜ì—¬ í…ŒìŠ¤íŠ¸í•´ ë³´ì„¸ìš”.</p>

    <section id="image-prediction-section">
        <h2>ğŸ“· ì´ë¯¸ì§€ & ì˜ìƒ AI Hub</h2>
        <p>íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³ , ì›í•˜ëŠ” AI ëª¨ë¸ì„ ì„ íƒí•˜ì—¬ ì˜ˆì¸¡ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>

        <div class="upload-section">
            <h3>1. íŒŒì¼ ì„ íƒ</h3>
            <input type="file" id="fileInput" required>
        </div>

        <div class="upload-section">
            <h3>2. ëª¨ë¸ ì„ íƒ ë° ì˜ˆì¸¡ ì‹¤í–‰</h3>
            <button onclick="runPrediction('team1')">ë™ë¬¼ ë¶„ë¥˜</button>
            <button onclick="runPrediction('team2')">ì¬í™œìš©í’ˆ ë¶„ë¥˜</button>
            <button onclick="runPrediction('team3')">ê³µêµ¬ ë¶„ë¥˜</button>
            <button onclick="runPrediction('yolo')">YOLO ê°ì²´ íƒì§€</button>
        </div>

        <div id="loading" style="display: none;">
            <p>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
            <div class="loader"></div>
        </div>

        <div class="result-container">
            <h3>ê²°ê³¼</h3>
            <div id="result">ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            <div class="preview-container">
                <img id="preview-image" src="" style="display: none; max-width: 100%; height: auto;">
                <video id="preview-video" src="" style="display: none; max-width: 100%; height: auto;" controls></video>
            </div>
        </div>
    </section>

    <hr style="margin: 40px 0;">

    <section id="stock-prediction-section" class="stock-body">
        <h2>ğŸ“ˆ ì‚¼ì„± ì£¼ê°€ ì˜ˆì¸¡</h2>
        <p>AIë¥¼ í™œìš©í•œ ì‚¼ì„± ì£¼ê°€ ì˜ˆì¸¡ ëª¨ë¸ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <form id="period-form">
          <label style="margin-right: 10px">
            <input type="radio" name="period" value="1d" /> 1ì¼
          </label>
          <label style="margin-right: 10px">
            <input type="radio" name="period" value="5d" checked /> 5ì¼ (4ì¼ì¹˜ ë°ì´í„° ì‚¬ìš©)
          </label>
        </form>

        <button id="fetch-data-btn">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>

        <div id="data-display"><p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>

        <div id="predict-buttons">
          <button data-model="RNN">RNN ì˜ˆì¸¡í•˜ê¸°</button>
          <button data-model="LSTM">LSTM ì˜ˆì¸¡í•˜ê¸°</button>
          <button data-model="GRU">GRU ì˜ˆì¸¡í•˜ê¸°</button>
        </div>

        <h2>ğŸ“Š ì˜ˆì¸¡ ê²°ê³¼</h2>
        <div id="prediction-results">
          <h3>RNN: ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘</h3>
          <h3>LSTM: ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘</h3>
          <h3>GRU: ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘</h3>
        </div>

        <h2>ğŸ“‰ ì£¼ê°€ ë°ì´í„° ê·¸ë˜í”„</h2>
        <div>
          <canvas id="stock-chart" width="100%" height="400"></canvas>
        </div>
    </section>

    <script>
        // ==========================================================
        // JavaScript for Image & Video AI Hub
        // ==========================================================
        function runPrediction(modelType) {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert("ë¨¼ì € ì´ë¯¸ì§€/ì˜ìƒ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
                return;
            }
            const file = fileInput.files[0];
            displayPreview(file);

            const formData = new FormData();
            formData.append("image", file);

            $.ajax({
                url: `/predict/${modelType}`,
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: function() {
                    $('#loading').show();
                    $('#result').html('');
                },
                success: function(response) {
                    if (modelType === "yolo") {
                        $('#loading p').text('YOLO ëª¨ë¸ì´ ì˜ìƒì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...');
                        pollForResult(response.status_url); // Pass the full status URL
                    } else {
                        $('#loading').hide();
                        $('#result').html(`
                            <p><strong>íŒŒì¼ëª…:</strong> ${response.filename}</p>
                            <p><strong>ì˜ˆì¸¡ ê²°ê³¼:</strong> ${response.predicted_class}</p>
                            <p><strong>ì •í™•ë„:</strong> ${response.confidence}</p>
                        `);
                    }
                },
                error: function(jqXHR) {
                    $('#loading').hide();
                    const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.error : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ ë°œìƒ";
                    $('#result').html(`<p style='color:red;'>ì˜ˆì¸¡ ì‹¤íŒ¨: ${errorMsg}</p>`);
                }
            });
        }

        function pollForResult(statusUrl) {
            const interval = setInterval(() => {
                $.get(statusUrl)
                    .done(function(response) {
                        if (response.status === 'complete') {
                            clearInterval(interval);
                            $('#loading').hide();
                            const resultUrl = new URL(statusUrl);
                            resultUrl.pathname = response.url; // Use relative path from status response

                            const isVideo = resultUrl.pathname.toLowerCase().endsWith('.mp4');
                            $('#result').html(`
                                <p><strong>ì²˜ë¦¬ ì™„ë£Œ!</strong></p>
                                <a href="${resultUrl.href}" download>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ</a>
                            `);
                            if (isVideo) {
                                $('#preview-video').attr('src', resultUrl.href).show();
                                $('#preview-image').hide();
                            } else {
                                $('#preview-image').attr('src', resultUrl.href).show();
                                $('#preview-video').hide();
                            }
                        }
                    })
                    .fail(function() {
                        clearInterval(interval);
                        $('#loading').hide();
                        $('#result').html("<p style='color:red;'>ê²°ê³¼ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>");
                    });
            }, 2000);
        }

        function displayPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const isVideo = file.type.startsWith('video/');
                if (isVideo) {
                    $('#preview-video').attr('src', e.target.result).show();
                    $('#preview-image').hide();
                } else {
                    $('#preview-image').attr('src', e.target.result).show();
                    $('#preview-video').hide();
                }
            };
            reader.readAsDataURL(file);
        }

        // ==========================================================
        // JavaScript for Stock Prediction
        // ==========================================================

        // State variables
        let stockData = [];
        let predictions = {};
        let stockLoading = false;
        let selectedPeriod = '5d'; // Default value
        let chartInstance = null;

        // DOM element references
        const periodForm = document.getElementById('period-form');
        const fetchDataBtn = document.getElementById('fetch-data-btn');
        const dataDisplay = document.getElementById('data-display');
        const predictButtonsContainer = document.getElementById('predict-buttons');
        const predictionResults = document.getElementById('prediction-results');
        const chartCanvas = document.getElementById('stock-chart').getContext('2d');

        const setStockLoading = (isLoading) => {
            stockLoading = isLoading;
            fetchDataBtn.disabled = stockLoading;
            fetchDataBtn.textContent = stockLoading ? 'ë¡œë”© ì¤‘...' : 'ë°ì´í„° ê°€ì ¸ì˜¤ê¸°';
            document.querySelectorAll('#predict-buttons button').forEach((btn) => (btn.disabled = stockLoading));
        };

        const getNextBusinessDay = (dateStr) => {
            let date = new Date(dateStr);
            do {
                date.setDate(date.getDate() + 1);
            } while (date.getDay() === 0 || date.getDay() === 6);
            return date.toISOString().split('T')[0];
        };

        periodForm.addEventListener('change', (event) => {
            selectedPeriod = event.target.value;
        });

        fetchDataBtn.addEventListener('click', async () => {
            if (!selectedPeriod) {
                alert('ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }
            setStockLoading(true);
            try {
                const response = await fetch(`/api/stockdata?period=${selectedPeriod}`);
                if (!response.ok) throw new Error('ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                const data = await response.json();
                stockData = data;
                predictions = {};
                renderStockData();
                renderPredictionResults();
                updateChart();
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
            setStockLoading(false);
        });

        predictButtonsContainer.addEventListener('click', async (event) => {
            if (event.target.tagName !== 'BUTTON') return;
            const modelType = event.target.dataset.model;

            if (!selectedPeriod || stockData.length === 0) {
                alert('ê¸°ê°„ì„ ì„ íƒí•˜ê³  ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¨ í›„ ì˜ˆì¸¡í•˜ì„¸ìš”.');
                return;
            }

            const inputData = stockData.map((item) => [
                parseFloat(item.Open) || 0,
                parseFloat(item.High) || 0, // ìˆœì„œ ìˆ˜ì •: ì‹œê³ ì €ì¢…
                parseFloat(item.Low) || 0,
                parseFloat(item.Close) || 0,
            ]);

            setStockLoading(true);
            try {
                // Flaskì˜ /api/predict2/ endpointë¥¼ ì‚¬ìš©
                const response = await fetch(`/api/predict2/${modelType}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: inputData,
                        period: selectedPeriod,
                    }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'ì˜ˆì¸¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                const result = await response.json();
                predictions[modelType] = result.prediction;
                renderPredictionResults();
                updateChart();
            } catch (error) {
                console.error(error);
                alert(error.message);
            }
            setStockLoading(false);
        });

        const renderStockData = () => {
            if (stockData.length === 0) {
                dataDisplay.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            dataDisplay.innerHTML = stockData.map((item, index) => `
                <div class="data-item">
                    <h4>${index + 1}ë²ˆì§¸ ë‚  (${item.Date})</h4>
                    <p>ì‹œê°€: ${item.Open}, ê³ ê°€: ${item.High}, ì €ê°€: ${item.Low}, ì¢…ê°€: ${item.Close}</p>
                </div>`).join('');
        };

        const renderPredictionResults = () => {
            predictionResults.innerHTML = ['RNN', 'LSTM', 'GRU'].map(model =>
                `<h3>${model}: ${predictions[model] ? predictions[model].toLocaleString() + ' ì›' : 'ì˜ˆì¸¡ ëŒ€ê¸° ì¤‘'}</h3>`
            ).join('');
        };

        const updateChart = () => {
            if (chartInstance) chartInstance.destroy();
            if (stockData.length === 0) return;

            const lastDate = stockData[stockData.length - 1].Date;
            const nextBusinessDay = getNextBusinessDay(lastDate);
            const labels = stockData.map(d => d.Date);
            if (Object.keys(predictions).length > 0) {
                labels.push(nextBusinessDay);
            }

            const closeData = stockData.map(d => parseFloat(d.Close));
            const createPredictionDataset = (model, color) => {
                const data = new Array(stockData.length).fill(null);
                if (predictions[model]) {
                    data.push(parseFloat(predictions[model]));
                }
                return {
                    label: `${model} ì˜ˆì¸¡`,
                    data: data,
                    borderColor: color,
                    tension: 0.1,
                    pointRadius: 5,
                    pointBackgroundColor: color,
                };
            };

            chartInstance = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ì‹¤ì œ ì¢…ê°€', data: closeData, borderColor: '#8884d8', tension: 0.1 },
                        createPredictionDataset('RNN', '#ff0000'),
                        createPredictionDataset('LSTM', '#00ff00'),
                        createPredictionDataset('GRU', '#0000ff'),
                    ],
                },
                options: { responsive: true, maintainAspectRatio: false },
            });
        };

        // ì´ˆê¸° ë Œë”ë§
        updateChart();

    </script>
</body>
</html>