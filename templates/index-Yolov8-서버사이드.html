<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Model Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>AI Model Hub</h1>
    <p>파일을 업로드하고, 원하는 AI 모델을 선택하여 예측을 실행하세요.</p>

    <div class="upload-section">
        <h3>1. 파일 선택</h3>
        <input type="file" id="fileInput" required>
    </div>

    <div class="upload-section">
        <h3>2. 모델 선택 및 예측 실행</h3>
        <button onclick="runPrediction('team1')">동물 분류</button>
        <button onclick="runPrediction('team2')">재활용품 분류</button>
        <button onclick="runPrediction('team3')">공구 분류</button>
        <button onclick="runPrediction('yolo')">YOLO 객체 탐지</button>
    </div>

    <div id="loading" style="display: none;">
        <p>처리 중입니다... 잠시만 기다려 주세요.</p>
        <div class="loader"></div>
    </div>

    <div class="result-container">
        <h3>결과</h3>
        <div id="result">결과가 여기에 표시됩니다.</div>
        <div class="preview-container">
            <img id="preview-image" src="" style="display: none;">
            <video id="preview-video" src="" style="display: none;" controls></video>
        </div>
    </div>

    <script>
        // 모델 예측 실행 함수
        function runPrediction(modelType) {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) {
                alert("먼저 파일을 선택하세요.");
                return;
            }
            const file = fileInput.files[0];
            displayPreview(file); // 예측 시작 시 미리보기 표시

            const formData = new FormData();
            formData.append("image", file);

            $.ajax({
                url: `/predict/${modelType}`, // 통합된 API 경로 사용
                type: "POST",
                data: formData,
                contentType: false,
                processData: false,
                beforeSend: function() {
                    $('#loading').show();
                    $('#result').html('');
                },
                success: function(response) {
                    if (modelType === "yolo") {
                        // YOLO는 폴링 시작
                        $('#loading p').text('YOLO 모델이 영상을 처리 중입니다...');
                        pollForResult(response.output_filename);
                    } else {
                        // 이미지 분류 결과는 바로 표시
                        $('#loading').hide();
                        $('#result').html(`
                            <p><strong>파일명:</strong> ${response.filename}</p>
                            <p><strong>예측 결과:</strong> ${response.predicted_class}</p>
                            <p><strong>정확도:</strong> ${response.confidence}</p>
                        `);
                    }
                },
                error: function(jqXHR) {
                    $('#loading').hide();
                    const errorMsg = jqXHR.responseJSON ? jqXHR.responseJSON.error : "알 수 없는 오류 발생";
                    $('#result').html(`<p style='color:red;'>예측 실패: ${errorMsg}</p>`);
                }
            });
        }

        // YOLO 결과 폴링 함수
        function pollForResult(filename) {
            const interval = setInterval(() => {
                $.get(`/status/${filename}`)
                    .done(function(response) {
                        if (response.status === 'complete') {
                            clearInterval(interval);
                            $('#loading').hide();
                            const isVideo = response.url.toLowerCase().endsWith('.mp4');
                            $('#result').html(`
                                <p><strong>처리 완료!</strong></p>
                                <a href="${response.url}" download>결과 다운로드</a>
                            `);
                            if (isVideo) {
                                $('#preview-video').attr('src', response.url).show();
                                $('#preview-image').hide();
                            } else {
                                $('#preview-image').attr('src', response.url).show();
                                $('#preview-video').hide();
                            }
                        }
                    })
                    .fail(function() {
                        clearInterval(interval);
                        $('#loading').hide();
                        $('#result').html("<p style='color:red;'>결과 확인 중 오류 발생</p>");
                    });
            }, 2000); // 2초마다 상태 확인
        }

        // 파일 미리보기 함수
        function displayPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const isVideo = file.type.startsWith('video/');
                if (isVideo) {
                    $('#preview-video').attr('src', e.target.result).show();
                    $('#preview-image').hide();
                } else {
                    $('#preview-image').attr('src', e.target.result).show();
                    $('#preview-video').hide();
                }
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>
</html>